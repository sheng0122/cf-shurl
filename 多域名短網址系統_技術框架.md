# 多域名短網址系統 - 技術框架與環境設定

> 文件版本：1.1  
> 更新日期：2025-05

---

## 1. 技術棧總覽

### 1.1 架構圖

```
┌─────────────────────────────────────────────────────────────────┐
│                        使用者/爬蟲請求                           │
└─────────────────────────────────────────────────────────────────┘
                              │
            ┌─────────────────┴─────────────────┐
            ▼                                   ▼
┌─────────────────────┐             ┌─────────────────────┐
│   短網址域名         │             │   管理後台域名       │
│   link.brand.com    │             │   admin.brand.com   │
└─────────────────────┘             └─────────────────────┘
            │                                   │
            ▼                                   ▼
┌─────────────────────┐             ┌─────────────────────┐
│  Cloudflare Worker  │             │  Cloudflare Access  │
│  - 偵測 User-Agent  │             │    (身份驗證)        │
│  - 一般: redirect   │             └─────────────────────┘
│  - 爬蟲: 回傳 OG    │                         │
└─────────────────────┘                         ▼
            │                       ┌─────────────────────┐
            │                       │  Cloudflare Pages   │
            │                       │  (前端 + Functions) │
            │                       └─────────────────────┘
            │                                   │
            └───────────────┬───────────────────┘
                            ▼
          ┌─────────────────┴─────────────────┐
          ▼                                   ▼
┌─────────────────────┐             ┌─────────────────────┐
│   Cloudflare KV     │             │   Cloudflare R2     │
│   (資料儲存)         │             │  (圖片儲存)         │
└─────────────────────┘             └─────────────────────┘
```

### 1.2 核心技術清單

| 類別 | 技術 | 用途 |
|------|------|------|
| 平台 | Cloudflare | 整體基礎設施 |
| 運算 | Cloudflare Workers | 短網址 redirect + OG 處理 |
| 前端託管 | Cloudflare Pages | 管理後台網頁 |
| 後端 API | Pages Functions | 管理 API 端點 |
| 資料庫 | Cloudflare KV | 短網址資料儲存 |
| 檔案儲存 | Cloudflare R2 | OG 圖片儲存 |
| 身份驗證 | Cloudflare Access | 後台登入保護 |
| 版本控制 | GitHub | 程式碼管理與自動部署 |
| 開發工具 | Wrangler CLI | 本地開發與部署 |

---

## 2. 開發環境設定

### 2.1 必要工具

| 工具 | 版本 | 安裝方式 |
|------|------|----------|
| Node.js | v18+ | https://nodejs.org |
| npm / pnpm | 最新版 | 隨 Node.js / `npm i -g pnpm` |
| Git | 最新版 | https://git-scm.com |
| Wrangler CLI | 最新版 | `npm install -g wrangler` |

### 2.2 安裝步驟

```bash
# 1. 確認 Node.js 版本
node -v  # 應該是 v18 以上

# 2. 安裝 Wrangler CLI
npm install -g wrangler

# 3. 登入 Cloudflare
wrangler login

# 4. 確認登入成功
wrangler whoami
```

### 2.3 VS Code 推薦套件

```json
{
  "recommendations": [
    "dbaeumer.vscode-eslint",
    "esbenp.prettier-vscode",
    "bradlc.vscode-tailwindcss",
    "eamodio.gitlens",
    "rangav.vscode-thunder-client"
  ]
}
```

### 2.4 帳號需求

| 服務 | 說明 | 網址 |
|------|------|------|
| Cloudflare | 主要平台 | https://dash.cloudflare.com |
| GitHub | 程式碼託管 | https://github.com |
| 域名 | 至少一個，DNS 託管在 Cloudflare | - |

---

## 3. 專案結構

### 3.1 目錄結構

```
url-shortener/
│
├── public/                      # 前端靜態資源
│   ├── index.html               # 主頁面（Dashboard）
│   ├── create.html              # 建立短網址頁面
│   ├── list.html                # 短網址列表頁面
│   │
│   ├── css/
│   │   └── style.css            # 自訂樣式（搭配 Tailwind）
│   │
│   └── js/
│       ├── app.js               # 主要邏輯
│       ├── api.js               # API 呼叫封裝
│       ├── qrcode.js            # QR Code 生成
│       └── og-preview.js        # OG 預覽功能
│
├── functions/                   # Pages Functions (API)
│   └── api/
│       ├── links.js             # GET: 列表, POST: 建立
│       ├── links/
│       │   └── [code].js        # GET/PUT/DELETE 單一短網址
│       ├── upload/
│       │   └── image.js         # POST: 上傳圖片到 R2
│       └── og/
│           └── preview.js       # POST: OG 預覽
│
├── worker/                      # Redirect Worker（獨立部署）
│   ├── src/
│   │   ├── index.js             # 主要 Worker 邏輯
│   │   ├── bot-detect.js        # 爬蟲偵測
│   │   └── og-page.js           # OG HTML 生成
│   ├── wrangler.toml            # Worker 設定
│   └── package.json
│
├── shared/                      # 共用程式碼（可選）
│   ├── constants.js             # 常數定義
│   └── validators.js            # 驗證函數
│
├── wrangler.toml                # Pages 設定
├── package.json
├── .gitignore
└── README.md
```

### 3.2 兩個部署單元

這個專案有兩個獨立的 Cloudflare 部署：

| 部署單元 | 位置 | 用途 | 部署目標 |
|----------|------|------|----------|
| Pages 專案 | `/` 根目錄 | 管理後台 + API | admin.yourdomain.com |
| Worker 專案 | `/worker` 目錄 | 短網址 redirect | link.yourdomain.com |

兩者共用同一個 KV namespace 和 R2 bucket。

---

## 4. 前端技術選型

### 4.1 方案：Vanilla JS + Tailwind CSS

考量專案規模，選擇輕量方案：

- 不需要 build 步驟
- Tailwind 使用 CDN 版本
- 功能單純，不需複雜狀態管理
- 未來需要可遷移到框架

### 4.2 前端依賴（CDN）

```html
<!-- Tailwind CSS -->
<script src="https://cdn.tailwindcss.com"></script>

<!-- Alpine.js（輕量互動） -->
<script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>

<!-- QR Code 生成 -->
<script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>

<!-- 複製到剪貼簿 -->
<script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.11/dist/clipboard.min.js"></script>
```

### 4.3 前端頁面功能

| 頁面 | 路徑 | 功能 |
|------|------|------|
| Dashboard | `/` | 總覽、統計、最近建立 |
| 建立短網址 | `/create.html` | 表單、OG 設定、QR 預覽 |
| 短網址列表 | `/list.html` | 搜尋、篩選、管理 |
| 短網址詳情 | `/detail.html?code=xxx` | 編輯、統計、QR 下載 |

---

## 5. 後端 API 規格

### 5.1 API 端點

| 方法 | 端點 | 功能 |
|------|------|------|
| `GET` | `/api/links` | 列出所有短網址 |
| `POST` | `/api/links` | 建立新短網址 |
| `GET` | `/api/links/:code` | 取得單一短網址 |
| `PUT` | `/api/links/:code` | 更新短網址 |
| `DELETE` | `/api/links/:code` | 刪除短網址 |
| `POST` | `/api/upload/image` | 上傳 OG 圖片 |
| `POST` | `/api/og/preview` | 預覽 OG 效果 |

### 5.2 Pages Functions 範例

**functions/api/links.js**

```javascript
import { nanoid } from 'nanoid';

// GET /api/links - 列出所有短網址
export async function onRequestGet({ env }) {
  const index = await env.LINKS.get('_index', 'json') || [];
  
  const links = await Promise.all(
    index.map(async (code) => {
      const data = await env.LINKS.get(code, 'json');
      return { code, ...data };
    })
  );
  
  return Response.json({ success: true, data: links });
}

// POST /api/links - 建立短網址
export async function onRequestPost({ request, env }) {
  const body = await request.json();
  const { url, domain, customCode, og } = body;
  
  // 驗證 URL
  try {
    const parsed = new URL(url);
    if (!['http:', 'https:'].includes(parsed.protocol)) {
      return Response.json(
        { success: false, error: 'Invalid protocol' },
        { status: 400 }
      );
    }
  } catch {
    return Response.json(
      { success: false, error: 'Invalid URL' },
      { status: 400 }
    );
  }
  
  // 產生或使用自訂短碼
  const code = customCode || nanoid(8);
  
  // 檢查短碼是否已存在
  const existing = await env.LINKS.get(code);
  if (existing) {
    return Response.json(
      { success: false, error: 'Code already exists' },
      { status: 409 }
    );
  }
  
  // 儲存資料
  const data = {
    url,
    domain: domain || 'link.yourdomain.com',
    createdAt: new Date().toISOString(),
    clicks: 0,
    og: og || { enabled: false }
  };
  
  await env.LINKS.put(code, JSON.stringify(data));
  
  // 更新索引
  const index = await env.LINKS.get('_index', 'json') || [];
  index.unshift(code);
  await env.LINKS.put('_index', JSON.stringify(index));
  
  return Response.json({
    success: true,
    data: {
      code,
      shortUrl: `https://${data.domain}/${code}`,
      ...data
    }
  });
}
```

**functions/api/links/[code].js**

```javascript
// GET /api/links/:code
export async function onRequestGet({ params, env }) {
  const { code } = params;
  const data = await env.LINKS.get(code, 'json');
  
  if (!data) {
    return Response.json(
      { success: false, error: 'Not found' },
      { status: 404 }
    );
  }
  
  return Response.json({ success: true, data: { code, ...data } });
}

// PUT /api/links/:code
export async function onRequestPut({ params, request, env }) {
  const { code } = params;
  const updates = await request.json();
  
  const existing = await env.LINKS.get(code, 'json');
  if (!existing) {
    return Response.json(
      { success: false, error: 'Not found' },
      { status: 404 }
    );
  }
  
  const data = {
    ...existing,
    ...updates,
    updatedAt: new Date().toISOString()
  };
  
  await env.LINKS.put(code, JSON.stringify(data));
  
  return Response.json({ success: true, data: { code, ...data } });
}

// DELETE /api/links/:code
export async function onRequestDelete({ params, env }) {
  const { code } = params;
  
  const existing = await env.LINKS.get(code);
  if (!existing) {
    return Response.json(
      { success: false, error: 'Not found' },
      { status: 404 }
    );
  }
  
  await env.LINKS.delete(code);
  
  // 更新索引
  const index = await env.LINKS.get('_index', 'json') || [];
  const newIndex = index.filter(c => c !== code);
  await env.LINKS.put('_index', JSON.stringify(newIndex));
  
  return Response.json({ success: true });
}
```

---

## 6. Redirect Worker

### 6.1 主要邏輯

**worker/src/index.js**

```javascript
import { isSocialBot } from './bot-detect';
import { generateOGPage } from './og-page';

export default {
  async fetch(request, env) {
    const url = new URL(request.url);
    const code = url.pathname.slice(1);
    
    // 首頁或空路徑
    if (!code) {
      return new Response('URL Shortener', { status: 200 });
    }
    
    // 從 KV 取得資料
    const data = await env.LINKS.get(code, 'json');
    
    if (!data) {
      return new Response('Not found', { status: 404 });
    }
    
    // 檢查是否為社群爬蟲
    const userAgent = request.headers.get('User-Agent') || '';
    
    if (isSocialBot(userAgent) && data.og?.enabled) {
      // 回傳 OG 頁面給爬蟲
      return new Response(generateOGPage(data, code, url.origin), {
        headers: { 'Content-Type': 'text/html; charset=utf-8' }
      });
    }
    
    // 更新點擊統計（非同步，不阻塞 redirect）
    env.ctx.waitUntil(updateClicks(env, code, data));
    
    // 一般訪問，redirect
    return Response.redirect(data.url, 302);
  }
};

async function updateClicks(env, code, data) {
  data.clicks = (data.clicks || 0) + 1;
  data.lastClickedAt = new Date().toISOString();
  await env.LINKS.put(code, JSON.stringify(data));
}
```

### 6.2 爬蟲偵測

**worker/src/bot-detect.js**

```javascript
const SOCIAL_BOTS = [
  'facebookexternalhit',
  'Facebot',
  'LinkedInBot',
  'Twitterbot',
  'Slackbot',
  'TelegramBot',
  'Discordbot',
  'WhatsApp',
  'LINE',
  'Googlebot',
  'bingbot',
];

export function isSocialBot(userAgent) {
  const ua = userAgent.toLowerCase();
  return SOCIAL_BOTS.some(bot => ua.includes(bot.toLowerCase()));
}
```

### 6.3 OG 頁面生成

**worker/src/og-page.js**

```javascript
export function generateOGPage(data, code, origin) {
  const { url, og } = data;
  const shortUrl = `${origin}/${code}`;
  
  const title = escapeHtml(og.title || '');
  const description = escapeHtml(og.description || '');
  const image = og.image || '';
  const siteName = escapeHtml(og.siteName || '');
  const twitterCard = og.twitterCard || 'summary_large_image';
  
  return `<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>${title}</title>
  
  <!-- Open Graph -->
  <meta property="og:title" content="${title}">
  <meta property="og:description" content="${description}">
  <meta property="og:image" content="${image}">
  <meta property="og:url" content="${shortUrl}">
  <meta property="og:type" content="website">
  ${siteName ? `<meta property="og:site_name" content="${siteName}">` : ''}
  
  <!-- Twitter Card -->
  <meta name="twitter:card" content="${twitterCard}">
  <meta name="twitter:title" content="${title}">
  <meta name="twitter:description" content="${description}">
  <meta name="twitter:image" content="${image}">
  
  <!-- Redirect -->
  <meta http-equiv="refresh" content="0;url=${url}">
  <link rel="canonical" href="${url}">
</head>
<body>
  <p>正在跳轉至 <a href="${url}">${url}</a></p>
</body>
</html>`;
}

function escapeHtml(str) {
  return str
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;')
    .replace(/'/g, '&#039;');
}
```

---

## 7. Cloudflare 設定

### 7.1 建立 KV Namespace

```bash
# 建立 KV namespace
wrangler kv:namespace create "LINKS"

# 會輸出類似：
# { binding = "LINKS", id = "xxxxxxxxxxxx" }

# 建立 preview 用的 namespace（本地開發）
wrangler kv:namespace create "LINKS" --preview
```

### 7.2 建立 R2 Bucket

```bash
# 建立 R2 bucket（存放 OG 圖片）
wrangler r2 bucket create url-shortener-images
```

### 7.3 wrangler.toml (Pages)

```toml
name = "url-shortener-admin"
compatibility_date = "2024-01-01"

# KV binding
[[kv_namespaces]]
binding = "LINKS"
id = "你的_KV_ID"
preview_id = "你的_PREVIEW_KV_ID"

# R2 binding
[[r2_buckets]]
binding = "IMAGES"
bucket_name = "url-shortener-images"
```

### 7.4 wrangler.toml (Worker)

```toml
name = "url-shortener-redirect"
main = "src/index.js"
compatibility_date = "2024-01-01"

# KV binding（與 Pages 共用）
[[kv_namespaces]]
binding = "LINKS"
id = "你的_KV_ID"

# 多域名 routes
routes = [
  { pattern = "link.brand1.com/*", zone_name = "brand1.com" },
  { pattern = "go.brand2.com/*", zone_name = "brand2.com" }
]
```

### 7.5 Cloudflare Access 設定

1. 進入 Cloudflare Zero Trust Dashboard
2. Access → Applications → Add an application
3. 選擇 Self-hosted
4. Application domain: `admin.yourdomain.com`
5. 設定 Policy:
   - Policy name: `Admin Access`
   - Action: Allow
   - Include: Emails ending in `@yourdomain.com` 或特定 email

---

## 8. 部署流程

### 8.1 GitHub 連接（一次性）

1. 在 GitHub 建立新 repository
2. Cloudflare Dashboard → Pages → Create a project
3. Connect to Git → 選擇 GitHub
4. 授權並選擇 repository
5. Build settings:
   - Framework preset: None
   - Build command: (留空)
   - Build output directory: `public`
6. Environment variables:
   - 加入必要的環境變數
7. Save and Deploy

### 8.2 設定 KV/R2 Bindings

1. Pages 專案 → Settings → Functions
2. KV namespace bindings:
   - Variable name: `LINKS`
   - KV namespace: 選擇你建立的 namespace
3. R2 bucket bindings:
   - Variable name: `IMAGES`
   - R2 bucket: 選擇你建立的 bucket

### 8.3 日常開發流程

```bash
# 本地開發
cd url-shortener
npx wrangler pages dev public

# 提交變更
git add .
git commit -m "feat: add OG preview"
git push origin main

# 自動部署！等待 Cloudflare 完成即可
```

### 8.4 Worker 獨立部署

```bash
cd worker
npx wrangler deploy
```

---

## 9. 本地開發指令

| 指令 | 用途 |
|------|------|
| `npx wrangler pages dev public` | 啟動 Pages 本地開發 |
| `npx wrangler dev` | 啟動 Worker 本地開發 |
| `npx wrangler kv:key list --binding=LINKS` | 列出 KV keys |
| `npx wrangler kv:key get --binding=LINKS "code"` | 取得特定 key |
| `npx wrangler kv:key put --binding=LINKS "code" "value"` | 寫入 key |
| `npx wrangler r2 object list url-shortener-images` | 列出 R2 物件 |
| `npx wrangler deploy` | 部署 Worker |
| `npx wrangler pages deploy public` | 手動部署 Pages |
| `npx wrangler tail` | 即時查看 Worker logs |

---

## 10. QR Code 實作

### 10.1 前端生成（推薦）

```javascript
// public/js/qrcode.js

async function generateQRCode(url, options = {}) {
  const {
    width = 256,
    margin = 2,
    color = { dark: '#000000', light: '#FFFFFF' }
  } = options;
  
  // 使用 qrcode 套件
  const canvas = document.createElement('canvas');
  
  await QRCode.toCanvas(canvas, url, {
    width,
    margin,
    color
  });
  
  return canvas;
}

// 下載 QR Code
function downloadQR(canvas, filename = 'qrcode.png') {
  const link = document.createElement('a');
  link.download = filename;
  link.href = canvas.toDataURL('image/png');
  link.click();
}

// SVG 格式
async function generateQRCodeSVG(url) {
  return await QRCode.toString(url, { type: 'svg' });
}
```

### 10.2 嵌入 Logo

```javascript
async function generateQRCodeWithLogo(url, logoUrl, options = {}) {
  const canvas = await generateQRCode(url, { ...options, width: 300 });
  const ctx = canvas.getContext('2d');
  
  // 載入 Logo
  const logo = new Image();
  logo.crossOrigin = 'anonymous';
  
  await new Promise((resolve, reject) => {
    logo.onload = resolve;
    logo.onerror = reject;
    logo.src = logoUrl;
  });
  
  // 在中央繪製 Logo
  const logoSize = canvas.width * 0.2;
  const logoX = (canvas.width - logoSize) / 2;
  const logoY = (canvas.height - logoSize) / 2;
  
  // 白色背景
  ctx.fillStyle = '#FFFFFF';
  ctx.fillRect(logoX - 5, logoY - 5, logoSize + 10, logoSize + 10);
  
  // 繪製 Logo
  ctx.drawImage(logo, logoX, logoY, logoSize, logoSize);
  
  return canvas;
}
```

---

## 11. 圖片上傳（R2）

### 11.1 上傳 API

**functions/api/upload/image.js**

```javascript
export async function onRequestPost({ request, env }) {
  const formData = await request.formData();
  const file = formData.get('file');
  
  if (!file) {
    return Response.json(
      { success: false, error: 'No file provided' },
      { status: 400 }
    );
  }
  
  // 驗證檔案類型
  const allowedTypes = ['image/jpeg', 'image/png', 'image/gif', 'image/webp'];
  if (!allowedTypes.includes(file.type)) {
    return Response.json(
      { success: false, error: 'Invalid file type' },
      { status: 400 }
    );
  }
  
  // 驗證檔案大小（5MB）
  if (file.size > 5 * 1024 * 1024) {
    return Response.json(
      { success: false, error: 'File too large' },
      { status: 400 }
    );
  }
  
  // 產生唯一檔名
  const ext = file.name.split('.').pop();
  const filename = `og/${Date.now()}-${crypto.randomUUID()}.${ext}`;
  
  // 上傳到 R2
  await env.IMAGES.put(filename, file.stream(), {
    httpMetadata: { contentType: file.type }
  });
  
  // 回傳公開 URL
  const publicUrl = `https://你的R2公開域名/${filename}`;
  
  return Response.json({
    success: true,
    data: { url: publicUrl, filename }
  });
}
```

### 11.2 R2 公開存取設定

1. Cloudflare Dashboard → R2
2. 選擇 bucket → Settings
3. Public access → Allow Access
4. 設定 Custom Domain 或使用 r2.dev 域名

---

## 12. 開發檢查清單

### 環境準備

- [ ] 安裝 Node.js v18+
- [ ] 安裝 Wrangler CLI
- [ ] 登入 Cloudflare (`wrangler login`)
- [ ] 註冊/登入 GitHub 帳號
- [ ] 取得短網址域名並加入 Cloudflare DNS

### Cloudflare 設定

- [ ] 建立 KV namespace
- [ ] 建立 R2 bucket
- [ ] 建立 Pages 專案並連接 GitHub
- [ ] 設定 Pages KV binding
- [ ] 設定 Pages R2 binding
- [ ] 建立 Worker
- [ ] 設定 Worker routes
- [ ] 設定 Cloudflare Access
- [ ] 設定 Custom domain for Pages

### 開發里程碑

- [ ] Phase 1: 基本 redirect 功能
- [ ] Phase 2: 管理後台 CRUD
- [ ] Phase 3: QR Code 生成
- [ ] Phase 4: OG 自訂功能
- [ ] Phase 5: 圖片上傳
- [ ] Phase 6: 統計功能
- [ ] Phase 7: 測試與上線

---

## 13. UI/UX 設計資源

### 設計參考

| 資源 | 網址 | 說明 |
|------|------|------|
| Tailwind UI | https://tailwindui.com | 官方元件（部分免費） |
| Flowbite | https://flowbite.com | 免費 Tailwind 元件 |
| DaisyUI | https://daisyui.com | Tailwind 元件庫 |
| Headless UI | https://headlessui.com | 無樣式互動元件 |
| Heroicons | https://heroicons.com | Tailwind 官方圖示 |
| Dribbble | https://dribbble.com/search/dashboard | 設計靈感 |

### 競品參考

- Bitly (https://bitly.com)
- Short.io (https://short.io)
- Rebrandly (https://rebrandly.com)
- Dub.co (https://dub.co)

### 頁面規劃

| 頁面 | 功能 |
|------|------|
| Dashboard | 統計總覽、最近短網址、快速建立 |
| 建立短網址 | URL 輸入、域名選擇、OG 設定、QR 預覽 |
| 短網址列表 | 搜尋、篩選、排序、批次操作 |
| 短網址詳情 | 編輯、統計圖表、QR 下載、OG 預覽 |
| 設定 | 域名管理、預設值、API Key |

---

*文件結束*
